var Actors=function(engine){this.players={};this.npcs={};this.avatarID=-1;this.engine=engine;this.layer=new PIXI.Container};Actors.prototype.load=function(complete){complete()};Actors.prototype.create=function(actors,renderer){var keys;var i;if(actors.players!==undefined){keys=Object.keys(actors.players);for(i=0;i<keys.length;i++){if(keys[i]==this.avatarID){continue}var player=new Player(actors.players[keys[i]]);this.players[player.id]=player;this.layer.addChild(player.sprite)}}if(actors.npcs!==undefined){keys=Object.keys(actors.npcs);for(i=0;i<keys.length;i++){var npc=new NPC(actors.npcs[keys[i]],renderer);this.npcs[npc.id]=npc;this.layer.addChild(npc.sprite)}}};Actors.prototype.update=function(actors){var keys=Object.keys(actors.players);var i;for(i=0;i<keys.length;i++){var actor=actors.players[keys[i]];if(keys[i]==this.avatarID){this.engine.avatar.update(actor);continue}if(actor.remove){this.players[keys[i]].remove()}else{this.players[keys[i]].update(actor)}}keys=Object.keys(actors.npcs);for(i=0;i<keys.length;i++){this.npcs[keys[i]].update(actors.npcs[keys[i]])}};Actors.prototype.text=function(actors){if(actors.player){var player=this.players[actors.player.id];if(player){player.emote(actors.player.blurb)}}if(actors.npc){var npc=this.npc[actors.npc.id];if(npc){npc.emote(actors.npc.blurb)}}};Actors.prototype.tick=function(){var keys=Object.keys(this.players);for(var i=0;i<keys.length;i++){if(keys[i]==this.avatarID){continue}this.players[keys[i]].tick()}keys=Object.keys(this.npcs);for(i=0;i<keys.length;i++){this.npcs[keys[i]].tick()}};Actors.prototype.names=function(){var self=this;var keys=Object.keys(self.players);for(var i=0;i<keys.length;i++){self.players[keys[i]].nametag.alpha=1}};var Player=function(data){this.sprite=new PIXI.Container;this.sprite.position=data.position;this.text=new PIXI.extras.BitmapText("This is just a test",{font:"16px UO Classic (rough)",align:"center"});this.text.position.x=0;this.text.position.y=-64;this.text.alpha=0;this.nametag=new PIXI.extras.BitmapText(data.name,{font:"16px UO Classic (rough)",align:"center"});this.nametag.position.x=-1*Math.round(data.name.length*6/2);this.nametag.position.y=0;this.nametag.alpha=.5;this.direction=DIRECTION_S;this.health=100;this.stamina=100;this.experience=0;this.moving=false;this.attacking=false;this.dying=false;this.id=data.id;this.active=undefined;this.blurFilter=new PIXI.filters.BlurFilter;var prefix="skeleton";var self=this;var directions=4;var textures=[];var clip;var i;var j;for(i=0;i<directions;i++){textures=[];for(j=0;j<9;j++){textures[j]=PIXI.utils.TextureCache[prefix+"_walk_"+i+"_"+j+".png"]}clip=new PIXI.extras.MovieClip(textures);clip.position.x=-32;clip.position.y=-60;clip.animationSpeed=.2;clip.visible=false;self.sprite.addChild(clip)}for(i=0;i<directions;i++){textures=[];for(j=0;j<6;j++){textures[j]=PIXI.utils.TextureCache[prefix+"_slash_"+i+"_"+j+".png"]}clip=new PIXI.extras.MovieClip(textures);clip.position.x=-32;clip.position.y=-60;clip.animationSpeed=.2;clip.loop=false;clip.visible=false;self.sprite.addChild(clip)}self.active=self.sprite.children[self.direction];self.active.visible=true;self.active.gotoAndStop(0);self.sprite.addChild(this.text);self.sprite.addChild(this.nametag)};Player.prototype.update=function(player){var self=this;if(player.stamina!==undefined){self.stamina=player.stamina}if(player.experience!==undefined){self.experience=player.experience;for(var i=0;i<8;i++){self.sprite.children[i].tint=parseInt(shadeColor2("#FF0000",(100-self.experience)/100).replace("#","0x"),16)}}if(self.attacking){return}if(player.attack){self.active.stop();self.active.visible=false;var drawDirection=-1;if(self.direction==4||self.direction==6){drawDirection=DIRECTION_E}else if(self.direction==5||self.direction==7){drawDirection=DIRECTION_W}else{drawDirection=self.direction}var attackClip=self.sprite.children[drawDirection+4];attackClip.onComplete=function(){self.attacking=false;attackClip.visible=false;attackClip.gotoAndStop(0);self.active.visible=true;if(self.moving){self.active.play()}};attackClip.loop=false;attackClip.visible=true;attackClip.gotoAndPlay(0);self.attacking=true;return}if(player.death){self.active.stop();self.active.visible=false;self.moving=false;self.attacking=false;self.health=0;self.sprite.children[8].loop=false;self.sprite.children[8].visible=true;self.sprite.children[8].gotoAndPlay(0);return}if(player.position!==undefined){var drawDirection=player.direction;var wasMoving=self.moving;if(drawDirection==4||drawDirection==6){drawDirection=DIRECTION_E}else if(drawDirection==5||drawDirection==7){drawDirection=DIRECTION_W}if(self.sprite.position.x==player.position.x&&self.sprite.position.y==player.position.y){self.moving=false;self.active.gotoAndStop(0);return}self.moving=true;if(drawDirection!==self.direction){self.active.visible=false;self.active.stop();self.active=self.sprite.children[drawDirection];self.active.visible=true;self.active.play()}else{if(!wasMoving&&self.moving){self.active.play()}}self.direction=player.direction;self.sprite.position=player.position}};Player.prototype.emote=function(data){if(data.substring(0,4)=="/me "){data="*"+data.substring(4)+"*";this.text.font.tint=11184810}else{this.text.font.tint=16777215}this.text.text=data;this.text.position.x=data.length*-3;this.text.alpha=1};Player.prototype.tick=function(data){if(this.text.alpha>0){this.text.alpha-=.005}if(this.nametag.alpha>0){this.nametag.alpha-=.005}if(this.dying){if(this.sprite.alpha<0){engine.actors.layer.removeChild(this.sprite);delete engine.actors.players[this.id]}this.blurFilter.blurX+=2;this.sprite.alpha-=.025}};Player.prototype.remove=function(){this.sprite.filters=[this.blurFilter];this.dying=true};var NPC=function(npc,renderer){this.sprite=new PIXI.Container;this.sprite.position=npc.position;this.text=new PIXI.extras.BitmapText("",{font:"16px UO Classic (rough)",align:"left"});this.text.position.x=-1*Math.round(this.text.textWidth/2);this.text.position.y=-64;this.text.alpha=1;this.direction=DIRECTION_S;this.attacking=false;this.stamina=100;this.health=100;this.moving=false;this.id=npc.id;this.health_bar=new PIXI.Graphics;this.health_bar.position.x=-16;this.health_bar.position.y=4;this.health_bar.beginFill(65280);this.health_bar.lineStyle(2,0,1);this.health_bar.drawRect(0,0,32,5);this.npc_assets=["BELT_leather.png","BELT_rope.png","FEET_plate_armor_shoes.png","FEET_shoes_brown.png","HANDS_plate_armor_gloves.png","HEAD_chain_armor_helmet.png","HEAD_chain_armor_hood.png","HEAD_hair_blonde.png","HEAD_leather_armor_hat.png","HEAD_plate_armor_helmet.png","HEAD_robe_hood.png","LEGS_pants_greenish.png","LEGS_plate_armor_pants.png","LEGS_robe_skirt.png","TORSO_chain_armor_jacket_purple.png","TORSO_chain_armor_torso.png","TORSO_leather_armor_shirt_white.png","TORSO_leather_armor_torso.png","TORSO_plate_armor_torso.png","TORSO_robe_shirt_brown.png","TORSO_leather_armor_bracers.png","TORSO_leather_armor_shoulders.png","TORSO_plate_armor_arms_shoulders.png"];var directions=4;var textures=[];var self=this;var clip;var i;var j;var process_layer=function(action){var base=ROOT+"client/resource/actors/"+action+"/";var spritesheet=PIXI.utils.TextureCache[base+"BODY_human.png"].baseTexture;var model=new PIXI.Container;var modelTexture=PIXI.RenderTexture.create(spritesheet.width,spritesheet.height);var cols=Math.floor(spritesheet.width/64);var rows=Math.floor(spritesheet.height/64);model.addChild(new PIXI.Sprite(PIXI.utils.TextureCache[base+"BODY_human.png"]));for(i=0;i<npc.layers.length;i++){model.addChild(new PIXI.Sprite(PIXI.utils.TextureCache[base+self.npc_assets[npc.layers[i]]]))}if(action=="slash"){model.addChild(new PIXI.Sprite(PIXI.utils.TextureCache[base+"WEAPON_dagger.png"]))}renderer.render(model,modelTexture);for(i=0;i<rows;i++){textures=[];for(j=0;j<cols;j++){textures[j]=new PIXI.Texture(modelTexture,new PIXI.Rectangle(j*64,i*64,64,64))}clip=new PIXI.extras.MovieClip(textures);clip.position.x=-32;clip.position.y=-60;clip.animationSpeed=.2;clip.visible=false;self.sprite.addChild(clip)}};process_layer("walkcycle");process_layer("slash");process_layer("hurt");if(npc.id===0){for(i=0;i<8;i++){self.sprite.children[i].tint=2631720}}self.sprite.children[self.direction].visible=true;self.sprite.children[self.direction].gotoAndStop(0);self.sprite.addChild(self.text);self.sprite.addChild(self.health_bar)};NPC.prototype.update=function(npc){var self=this;if(npc.position){if(self.sprite.children[self.direction+4].visible){self.sprite.children[self.direction+4].visible=false;self.sprite.children[self.direction+4].gotoAndStop(0);self.sprite.children[self.direction].visible=true}if(!self.moving){self.sprite.children[self.direction].play()}if(self.direction!==npc.direction){self.sprite.children[self.direction].visible=false;self.sprite.children[self.direction].stop();self.sprite.children[npc.direction].visible=true;self.sprite.children[npc.direction].play()}self.direction=npc.direction;if(self.sprite.position.x==npc.position.x&&self.sprite.position.y==npc.position.y){self.moving=false;self.sprite.children[self.direction].gotoAndStop(0)}else{self.moving=true;self.sprite.position=npc.position}}if(npc.health!==undefined){self.health=npc.health;if(self.health<1){self.sprite.children[self.direction].visible=false;self.sprite.children[self.direction+4].visible=false;self.sprite.children[8].loop=false;self.sprite.children[8].visible=true;self.sprite.children[8].play();self.health_bar.clear()}else{self.health_bar.alpha=1;self.health_bar.clear();self.health_bar.lineStyle(2,0,1);self.health_bar.drawRect(0,0,32,5);self.health_bar.beginFill(65280);self.health_bar.lineStyle(0);self.health_bar.drawRect(1,1,Math.floor(32*(self.health/100))-1,4)}}else{if(self.health_bar.alpha>0&&self.health>=100){self.health_bar.alpha=self.health_bar.alpha-.025}}if(npc.attack===true){self.sprite.children[self.direction].visible=false;self.sprite.children[self.direction].stop();self.sprite.children[self.direction+4].visible=true;self.sprite.children[self.direction+4].gotoAndPlay(0)}if(npc.blurb!==undefined){self.emote(npc.blurb)}};NPC.prototype.emote=function(data){if(data.substring(0,4)=="/me "){data="*"+data.substring(4)+"*";this.text.font.tint=11184810}else{this.text.font.tint=16777215}this.text.text=data;this.text.position.x=-1*Math.round(data.length*6/2);this.text.alpha=1};NPC.prototype.tick=function(data){if(this.text.alpha>0){this.text.alpha-=.005}};var Avatar=function(engine){this.direction=0;this.sprite=new PIXI.Container;this.active=undefined;this.moving=false;this.attacking=false;this.typing=false;this.death=false;this.blurb="";this.health=100;this.stamina=100;this.experience=0;this.id="";this.engine=engine;this.text=undefined;this.keys={}};Avatar.prototype.create=function(avatar){this.health=avatar.health;this.stamina=avatar.stamina;this.experience=avatar.experience;this.id=avatar.id;this.text=new PIXI.extras.BitmapText("Hello, World!",{font:"16px UO Classic (rough)",align:"left"});this.text.position.x=0;this.text.position.y=-64;this.text.alpha=0;this.textEXP=new PIXI.extras.BitmapText("Hello, World!",{font:"16px UO Classic (rough)",align:"left"});this.textEXP.position.x=0;this.textEXP.position.y=-64;this.textEXP.alpha=0;this.textEXP.tint=16776960;this.statsBar=new PIXI.Graphics;this.statsBar.alpha=.5;this.statsBar.position.x=-16;this.statsBar.position.y=2;this.statsBar.beginFill(65280);this.statsBar.lineStyle(2,0,1);this.statsBar.drawRect(0,0,32,5);this.statsBar.drawRect(0,6,32,5);this.sprite.addChild(this.text);this.sprite.addChild(this.statsBar);this.sprite.addChild(this.textEXP);this.sprite.position=this.engine.position;for(var i=0;i<8;i++){this.sprite.children[i].tint=parseInt(shadeColor2("#FF0000",(100-this.experience)/100).replace("#","0x"),16)}};Avatar.prototype.update=function(avatar){var self=this;var draw=false;if(avatar.stamina!==undefined){self.stamina=avatar.stamina;draw=true}if(avatar.health!==undefined){self.health=avatar.health;draw=true}if(avatar.experience!==undefined){self.experience=avatar.experience;self.textEXP.text="+1 exp";self.textEXP.alpha=1;for(var i=0;i<8;i++){self.sprite.children[i].tint=parseInt(shadeColor2("#FF0000",(100-self.experience)/100).replace("#","0x"),16)}}if(avatar.death===true){self.active.visible=false;self.active.stop();self.active=self.sprite.children[8];self.active.onComplete=function(){self.engine.stage.alpha-=.01};self.active.loop=false;self.active.visible=true;self.active.gotoAndPlay(0);self.direction=avatar.direction;self.position=avatar.position;self.moving=false;self.attacking=false;self.typing=false;self.death=true;self.health=0}else if(avatar.death===false){self.position=avatar.position;self.engine.position=avatar.position;self.sprite.position=avatar.position;self.death=false;self.active.visible=false;self.active=self.sprite.children[self.direction];self.active.visible=true;self.active.gotoAndStop(0);self.engine.stage.alpha=1}if(draw){self.statsBar.clear();self.statsBar.lineStyle(2,0,1);self.statsBar.drawRect(0,0,32,5);self.statsBar.drawRect(0,6,32,5);self.statsBar.beginFill(65280);self.statsBar.lineStyle(0);self.statsBar.drawRect(1,1,Math.floor(32*(self.health/100))-1,4);self.statsBar.drawRect(1,7,Math.floor(32*(self.stamina/100))-1,4);self.statsBar.alpha=.5}};Avatar.prototype.load=function(complete){var self=this;var process_layer=function(resource,action){var index=0;var row=0;var col=0;var textures=[];var directions=4;var i=0;var prefix="skeleton";var spritesheet=PIXI.utils.TextureCache[resource].baseTexture;var cols=Math.floor(spritesheet.width/64);var rows=Math.floor(spritesheet.height/64);var frameTexture;var clip;for(row=0;row<rows;row++){textures[row]=[];for(col=0;col<cols;col++){frameTexture=new PIXI.Texture(spritesheet,{x:col*64,y:row*64,width:64,height:64});textures[row][col]=frameTexture;PIXI.Texture.addTextureToCache(frameTexture,prefix+"_"+action+"_"+row+"_"+col+".png");index++}}for(i=0;i<rows;i++){clip=new PIXI.extras.MovieClip(textures[i]);clip.position.x=-32;clip.position.y=-60;clip.animationSpeed=.2;clip.visible=false;self.sprite.addChild(clip)}};process_layer(ROOT+"client/resource/actors/walkcycle/BODY_skeleton.png","walk");process_layer(ROOT+"client/resource/actors/slash/BODY_skeleton.png","slash");process_layer(ROOT+"client/resource/actors/hurt/BODY_skeleton.png","hurt");self.direction=DIRECTION_S;self.active=self.sprite.children[self.direction];self.active.visible=true;self.active.gotoAndStop(0);complete()};Avatar.prototype.keydown=function(e){var self=this;var letter="";var name=KEY_CODES[e.keyCode];if(name=="spacebar"||name=="enter"||name=="up"||name=="down"||name=="left"||name=="right"||name=="backspace"){e.preventDefault()}if(engine.avatar.typing){if(e.keyCode==8){engine.avatar.blurb=engine.avatar.blurb.substring(0,engine.avatar.blurb.length-1)}else if(e.keyCode==13){engine.emit("text",engine.avatar.blurb);engine.avatar.emote(engine.avatar.blurb);engine.avatar.typing=false;engine.avatar.blurb="";engine.textInput.text=""}else if(e.keyCode==32){engine.avatar.blurb+=" "}else if(e.keyCode>64&&e.keyCode<91){letter=String.fromCharCode(e.keyCode);if(!e.shiftKey){letter=letter.toLowerCase()}engine.avatar.blurb+=letter}else if(e.keyCode>47&&e.keyCode<58){letter=String.fromCharCode(e.keyCode);if(e.shiftKey){switch(letter){case"1":letter="!";break;case"2":letter="@";break;case"3":letter="#";break;case"4":letter="$";break;case"5":letter="%";break;case"6":letter="^";break;case"7":letter="&";break;case"8":letter="*";break;case"9":letter="(";break;case"0":letter=")";break;default:letter="";break}}engine.avatar.blurb+=letter}else if(e.keyCode>185&&e.keyCode<193){switch(e.keyCode){case 186:letter=e.shiftKey?":":";";break;case 187:letter=e.shiftKey?"+":"=";break;case 188:letter=e.shiftKey?"<":",";break;case 189:letter=e.shiftKey?"_":"-";break;case 190:letter=e.shiftKey?">":".";break;case 191:letter=e.shiftKey?"?":"/";break;case 192:letter=e.shiftKey?"~":"`";break}engine.avatar.blurb+=letter}else if(e.keyCode>218&&e.keyCode<223){switch(e.keyCode){case 219:letter=e.shiftKey?"{":"[";break;case 220:letter=e.shiftKey?"|":"\\";break;case 221:letter=e.shiftKey?"}":"]";break;case 222:letter=e.shiftKey?'"':"'";break}engine.avatar.blurb+=letter}engine.textInput.text=engine.avatar.blurb}else{if(name=="enter"){if(engine.avatar.moving){engine.avatar.moving=false;engine.avatar.sprite.children[engine.avatar.direction].gotoAndStop(0);engine.emit("move",{position:engine.position,direction:engine.avatar.direction})}engine.avatar.typing=true}else if(name=="n"){engine.actors.names()}else if(name=="x"){var exp=engine.avatar.experience+" exp";engine.avatar.textEXP.text=exp;engine.avatar.textEXP.position.x=exp.length*-3;engine.avatar.textEXP.position.y=-64;engine.avatar.textEXP.alpha=1}else{engine.avatar.keys[KEY_CODES[e.keyCode]]=true}}};Avatar.prototype.keyup=function(e){engine.avatar.keys[KEY_CODES[e.keyCode]]=false};Avatar.prototype.emote=function(blurb){var self=this;if(blurb.substring(0,4)=="/me "){blurb="*"+blurb.substring(4)+"*";self.text.font.tint=11184810}else{self.text.font.tint=16777215}self.text.text=blurb;self.text.position.x=-1*Math.round(self.engine.textInput.textWidth/2);self.text.alpha=1};Avatar.prototype.tick=function(){var self=this;if(self.text.alpha>0){self.text.alpha-=.003}if(self.textEXP.alpha>0){self.textEXP.alpha-=.025;self.textEXP.y=self.textEXP.y-1}else{self.textEXP.y=-64}if(self.statsBar.alpha>0){if(self.stamina==100&&self.health==100){self.statsBar.alpha-=.003}}if(self.attacking||self.typing||self.death){return}var keys=self.keys;var amount=4;var animationSpeed=.2;var wasMoving=self.moving;var newDirection=self.direction;var newPosition=$.extend(true,{},self.engine.position);var positionChanged=false;var step=function(){var col=Math.floor(newPosition.x/TILE_WIDTH);var row=Math.floor(newPosition.y/TILE_HEIGHT);var stop=function(){self.active.gotoAndStop(0);self.moving=false;self.engine.emit("move",{position:self.engine.position,direction:self.direction})};if(self.engine.map.terrain.index[row]!==undefined){if(self.engine.map.terrain.index[row][col]!==undefined){if(self.engine.map.terrain.index[row][col][2]!==undefined&&self.engine.map.terrain.index[row][col][2]!==null){stop();return}}else{stop();return}}else{stop();return}var drawDirection=-1;self.moving=true;if(newDirection==4||newDirection==6){drawDirection=DIRECTION_E}else if(newDirection==5||newDirection==7){drawDirection=DIRECTION_W}else{drawDirection=newDirection}if(drawDirection!==self.direction){self.active.visible=false;self.active.stop();self.active=self.sprite.children[drawDirection];self.active.visible=true;self.active.play()}else{if(!wasMoving&&self.moving){self.active.play()}}self.active.animationSpeed=animationSpeed;self.direction=newDirection;self.engine.position=newPosition;self.sprite.position=self.engine.position;self.engine.emit("move",{position:self.engine.position,direction:self.direction})};if(self.keys.spacebar){if(self.stamina<10){self.emote("/me oof")}else{self.active.stop();self.active.visible=false;var drawDirection=-1;if(self.direction==4||self.direction==6){drawDirection=DIRECTION_E}else if(self.direction==5||self.direction==7){drawDirection=DIRECTION_W}else{drawDirection=self.direction}var attackClip=self.sprite.children[drawDirection+4];attackClip.onComplete=function(){self.attacking=false;attackClip.visible=false;attackClip.gotoAndStop(0);self.active.visible=true;if(self.moving){self.active.play()}};attackClip.loop=false;attackClip.visible=true;attackClip.gotoAndPlay(0);self.attacking=true;self.engine.emit("attack");return}}if(self.keys.shift){if(self.stamina>0){amount*=2;animationSpeed*=2}}if(self.keys["w"]||self.keys["up"]){if(self.keys["a"]||self.keys["left"]){amount*=MOVEMENT_ANGLE;newPosition.x-=amount;newDirection=DIRECTION_NW}else if(self.keys["d"]||self.keys["right"]){amount*=MOVEMENT_ANGLE;newPosition.x+=amount;newDirection=DIRECTION_NE}else{newDirection=DIRECTION_N}newPosition.y-=amount;step();return}if(self.keys["s"]||self.keys["down"]){if(self.keys["a"]||self.keys["left"]){amount*=MOVEMENT_ANGLE;newPosition.x-=amount;newDirection=DIRECTION_SW}else if(self.keys["d"]||self.keys["right"]){amount*=MOVEMENT_ANGLE;newPosition.x+=amount;newDirection=DIRECTION_SE}else{newDirection=DIRECTION_S}newPosition.y+=amount;step();return}if(self.keys["a"]||self.keys["left"]){newPosition.x-=amount;newDirection=DIRECTION_W;step();return}if(self.keys["d"]||self.keys["right"]){newPosition.x+=amount;newDirection=DIRECTION_E;step();return}if(self.moving){self.active.gotoAndStop(0);self.moving=false;self.engine.emit("move",{position:self.engine.position,direction:self.direction})}};var DIRECTION_N=0;var DIRECTION_W=1;var DIRECTION_S=2;var DIRECTION_E=3;var DIRECTION_NE=4;var DIRECTION_NW=5;var DIRECTION_SE=6;var DIRECTION_SW=7;var RENDER_STACK_LANDSCAPE=0;var RENDER_STACK_AVATAR=1;var MOVEMENT_ANGLE=.5;var CANVAS_WIDTH=896;var CANVAS_WIDTH_HALF=448;var CANVAS_HEIGHT=504;var CANVAS_HEIGHT_HALF=252;var TILE_WIDTH=32;var TILE_WIDTH_HALF=16;var TILE_HEIGHT=32;var TILE_HEIGHT_HALF=16;var TILE_Y_OFFSET=14;var VIEWPORT_WIDTH_TILES=Math.ceil(CANVAS_WIDTH/TILE_WIDTH)+1;var VIEWPORT_HEIGHT_TILES=Math.ceil(CANVAS_HEIGHT/TILE_HEIGHT)+1;var VIEWPORT_WIDTH_TILES_HALF=Math.ceil(VIEWPORT_WIDTH_TILES/2);var VIEWPORT_HEIGHT_TILES_HALF=Math.ceil(VIEWPORT_HEIGHT_TILES/2);var MODE_PAINT=0;var MODE_MOVE=1;var MODE_DELETE=2;var KEY_CODES={0:"Windows Menu (Windows-oriented keyboard used on Mac)",3:"break",8:"backspace",9:"tab",12:"clear",13:"enter",16:"shift",17:"ctrl ",18:"alt",19:"pause/break",20:"caps lock",27:"escape",32:"spacebar",33:"page up",34:"page down",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",41:"select",42:"print",43:"execute",44:"print_screen",45:"insert ",46:"delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:"semicolon (firefox), equals",60:"<",61:"equals (firefox)",63:"ß",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",91:"Windows Key / Left ⌘ / Chromebook Search key",92:"right window key ",93:"Windows Menu / Right ⌘",96:"numpad 0 ",97:"numpad 1 ",98:"numpad 2 ",99:"numpad 3 ",100:"numpad 4 ",101:"numpad 5 ",102:"numpad 6 ",103:"numpad 7 ",104:"numpad 8 ",105:"numpad 9 ",106:"multiply ",107:"add",108:"numpad period (firefox)",109:"subtract ",110:"decimal point",111:"divide ",112:"f1 ",113:"f2 ",114:"f3 ",115:"f4 ",116:"f5 ",117:"f6 ",118:"f7 ",119:"f8 ",120:"f9 ",121:"f10",122:"f11",123:"f12",124:"f13",125:"f14",126:"f15",127:"f16",128:"f17",129:"f18",130:"f19",144:"num lock ",145:"scroll lock",160:"^",163:"#",167:"page forward (Chromebook)",173:"minus (firefox), mute/unmute",174:"decrease volume level",175:"increase volume level",176:"next",177:"previous",178:"stop",179:"play/pause",180:"e-mail",181:"mute/unmute (firefox)",182:"decrease volume level (firefox)",183:"increase volume level (firefox)",186:"semi-colon / ñ",187:"equal sign ",188:"comma",189:"dash ",190:"period ",191:"forward slash / ç",192:"grave accent ",193:"?, / or °",194:"numpad period (chrome)",219:"open bracket ",220:"back slash ",221:"close bracket ",222:"single quote ",223:"`",224:"left or right ⌘ key (firefox)",225:"altgr",226:"< /git >",230:"GNOME Compose Key",255:"toggle touchpad"};var Engine=function(){this.stage;this.renderer;this.map;this.matrix;this.layerTerrain;this.layerAir;this.layerText;this.textInput;this.socket;this.avatar=new Avatar(this);this.terrain=new Terrain(this);this.actors=new Actors(this);this.position={x:220,y:220};this.alternator=false;this.initialized=false;this.focus=false};Engine.prototype.initialize=function(container,host,port,cwd){var self=this;self.host=host;self.port=port;self.cwd=cwd;self.socket=io(host+":"+port);self.socket.on("sync",function(actors){self.position=actors.player.position;self.avatar.create(actors.player);self.actors.avatarID=actors.player.id;self.actors.create(actors,self.renderer);self.position=actors.player.position;self.watch(true);self.initialized=true;self.ready()});self.socket.on("update",function(actors){if(self.initialized){self.actors.update(actors)}});self.socket.on("create",function(actors){if(self.initialized){self.actors.create(actors,self.renderer)}});self.socket.on("debug",function(data){console.log(data)});self.socket.on("stats",function(data){self.debugging(data)});self.socket.on("text",function(data){self.actors.text(data)});self.socket.on("disconnect",function(){self.stage.alpha=.1});self.matrix=new PIXI.Matrix;self.matrix.translate(0,0);var rendererOptions={antialias:false,transparent:false,resolution:1};self.renderer=new PIXI.autoDetectRenderer(CANVAS_WIDTH,CANVAS_HEIGHT,rendererOptions);self.stage=new PIXI.Container;container.appendChild(self.renderer.view);self.stage.mousedown=function(data){};var jqxhr=$.getJSON("//"+host+cwd+"client/maps/town.json",function(data){self.load(data)}).fail(function(d,textStatus,error){console.error("getJSON failed, status: "+textStatus+", error: "+error)})};Engine.prototype.load=function(map){var self=this;self.map=map;var i=0;var j=0;var loader=PIXI.loader;var actorActions=["walkcycle","slash","hurt"];var avatarAssets=["BODY_skeleton.png"];var npcAssets=["BODY_human.png","BELT_leather.png","BELT_rope.png","FEET_plate_armor_shoes.png","FEET_shoes_brown.png","HANDS_plate_armor_gloves.png","HEAD_chain_armor_helmet.png","HEAD_chain_armor_hood.png","HEAD_hair_blonde.png","HEAD_leather_armor_hat.png","HEAD_plate_armor_helmet.png","HEAD_robe_hood.png","LEGS_pants_greenish.png","LEGS_plate_armor_pants.png","LEGS_robe_skirt.png","TORSO_chain_armor_jacket_purple.png","TORSO_chain_armor_torso.png","TORSO_leather_armor_shirt_white.png","TORSO_leather_armor_torso.png","TORSO_plate_armor_torso.png","TORSO_robe_shirt_brown.png","TORSO_leather_armor_bracers.png","TORSO_leather_armor_shoulders.png","TORSO_plate_armor_arms_shoulders.png"];for(i=0;i<actorActions.length;i++){for(j=0;j<npcAssets.length;j++){loader.add(ROOT+"client/resource/actors/"+actorActions[i]+"/"+npcAssets[j])}for(j=0;j<avatarAssets.length;j++){loader.add(ROOT+"client/resource/actors/"+actorActions[i]+"/"+avatarAssets[j])}}loader.add("UO Classic (rough)",ROOT+"client/resource/uo.fnt");loader.add(ROOT+"client/resource/actors/slash/WEAPON_dagger.png");loader.on("progress",function(e){self.loading(e)});loader.on("error",function(e){console.log(e)});loader.once("complete",function(){self.loaded();self.terrain.load(map.terrain.source,self.renderer,function(error){self.layerTerrain=new PIXI.Sprite(self.terrain.textureGround);self.stage.addChild(self.layerTerrain);self.stage.addChild(self.actors.layer);self.actors.layer.addChild(self.avatar.sprite);self.layerAir=new PIXI.Sprite(self.terrain.textureAir);self.stage.addChild(self.layerAir);self.layerText=new PIXI.Container;self.textInput=new PIXI.extras.BitmapText("",{font:"16px UO Classic (rough)",align:"left"});self.textInput.position.x=0;self.textInput.position.y=CANVAS_HEIGHT-19;self.layerText.addChild(self.textInput);self.stage.addChild(self.layerText);self.avatar.load(function(error){self.actors.load(function(error){self.socket.emit("ready","ready")})})})});loader.load()};Engine.prototype.render=function(){var self=this;if(!self.initialized){return}self.alternator=!self.alternator;if(self.alternator){return}if(self.stage.alpha<1){if(self.stage.alpha>0){self.stage.alpha-=.01}}self.avatar.tick();self.actors.tick();self.actors.layer.children.sort(function(a,b){if(a.position.y<b.position.y)return-1;if(a.position.y>b.position.y)return 1;return 0});self.actors.layer.position={x:-self.position.x+CANVAS_WIDTH_HALF,y:-self.position.y+CANVAS_HEIGHT_HALF};self.matrix=new PIXI.Matrix;self.matrix.translate(-self.position.x+CANVAS_WIDTH_HALF,-self.position.y+CANVAS_HEIGHT_HALF);self.trans=new PIXI.Transform;self.matrix.decompose(self.trans);self.terrain.draw(self.map.terrain,self.matrix,self.position,self.renderer);self.renderer.render(self.stage)};Engine.prototype.watch=function(gainedFocus){var self=this;if(gainedFocus&&!self.focus){document.addEventListener("keydown",self.avatar.keydown,false);document.addEventListener("keyup",self.avatar.keyup,false);self.focus=true}if(!gainedFocus&&self.focus){document.removeEventListener("keydown",self.avatar.keydown,false);document.removeEventListener("keyup",self.avatar.keyup,false);self.focus=false}};Engine.prototype.debug=function(enabled){var self=this;if(enabled){self.socket.emit("join_debug")}else{self.socket.emit("leave_debug")}};Engine.prototype.emit=function(type,message){this.socket.emit("event",{type:type,message:message})};var Terrain=function(){this.textureGround;this.textureAir;this.Ground;this.Air;this.baseRenderer};Terrain.prototype.load=function(source,renderer,complete){var self=this;var worker=[];self.Ground=new PIXI.Container;self.Air=new PIXI.Container;self.textureGround=PIXI.RenderTexture.create(renderer.width,renderer.height);self.textureAir=PIXI.RenderTexture.create(renderer.width,renderer.height);source.forEach(function(asset){asset=ROOT+asset;worker.push(asset)});PIXI.loader.add(worker).after(function(event){var index=0;var row=0;var col=0;var frameTexture;var filename=event.url.split("/").pop();for(row=0;row<event.texture.height;row+=32){for(col=0;col<event.texture.width;col+=32){frameTexture=new PIXI.Texture(event.texture,{x:col,y:row,width:32,height:32});PIXI.Texture.addTextureToCache(frameTexture,"terrain_"+index);index++}}complete()}).on("error",function(e){console.log(e)}).once("complete",complete).load()};Terrain.prototype.draw=function(source,trans,position,renderer){var self=this;self.Ground.children=[];self.Air.children=[];var sprite;var startCol=Math.floor((position.x-CANVAS_WIDTH_HALF)/TILE_WIDTH);var startRow=Math.floor((position.y-CANVAS_HEIGHT_HALF)/TILE_HEIGHT);var maxCol=startCol+VIEWPORT_WIDTH_TILES+1;var maxRow=startRow+VIEWPORT_HEIGHT_TILES+1;var startX=startCol*TILE_WIDTH;var startY=startRow*TILE_HEIGHT;for(var row=startRow;row<maxRow;row++){for(var col=startCol;col<maxCol;col++){if(source.index[row]===undefined)continue;if(source.index[row][col]===undefined)continue;layers=source.index[row][col];if(layers.constructor!==Array)continue;for(i=0;i<layers.length;i++){index=layers[i];if(index!==null){sprite=new PIXI.Sprite(PIXI.Texture.fromFrame("terrain_"+index));sprite.position.x=startX+(col-startCol)*TILE_WIDTH;sprite.position.y=startY+(row-startRow)*TILE_HEIGHT;if(i<3){self.Ground.addChild(sprite)}else{self.Air.addChild(sprite)}}}}}renderer.render(self.Ground,self.textureGround,true,trans,false);renderer.render(self.Air,self.textureAir,true,trans,false)};function directionFromAngle(angle){if(angle>337.5||angle<22.5){return DIRECTION_E}if(angle>22.5&&angle<67.5){return DIRECTION_NE}if(angle>67.5&&angle<112.5){return DIRECTION_N}if(angle>112.5&&angle<157.5){return DIRECTION_NW}if(angle>157.5&&angle<202.5){return DIRECTION_W}if(angle>202.5&&angle<247.5){return DIRECTION_SW}if(angle>247.5&&angle<292.5){return DIRECTION_S}if(angle>292.5&&angle<337.5){return DIRECTION_SE}}function getRandomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}function lineDistanceSqrt(point1,point2){var xs=0;var ys=0;xs=point2.x-point1.x;xs=xs*xs;ys=point2.y-point1.y;ys=ys*ys;return Math.sqrt(xs+ys)}function lineDistanceManhattan(p1,p2){return Math.abs(p1.x-p2.x)+Math.abs(p1.y-p2.y)}function isNumber(o){return!isNaN(o-0)&&o!==null&&o!==""&&o!==false}function setPixel(imageData,x,y,r,g,b,a){var index=(parseInt(x)+parseInt(y)*imageData.width)*4;imageData.data[index+0]=r;imageData.data[index+1]=g;imageData.data[index+2]=b;imageData.data[index+3]=a}function getPixel(imageData,x,y){var index=(parseInt(x)+parseInt(y)*imageData.width)*4;return{r:imageData.data[index+0],g:imageData.data[index+1],b:imageData.data[index+2],a:imageData.data[index+3]}}function shadeColor2(color,percent){var f=parseInt(color.slice(1),16),t=percent<0?0:255,p=percent<0?percent*-1:percent,R=f>>16,G=f>>8&255,B=f&255;return"#"+(16777216+(Math.round((t-R)*p)+R)*65536+(Math.round((t-G)*p)+G)*256+(Math.round((t-B)*p)+B)).toString(16).slice(1);
}function Map(target,toolbar,map){var self=this;self.settings=map.settings;self.terrain=map.terrain;self.objects=map.objects;self.actors=map.actors;self.stage=null;self.renderer=null;self.canvas=null;self.invalidate=false;self.width=896;self.height=512;self.half_width=448;self.half_height=256;self.TILE_WIDTH=32;self.TILE_WIDTH_HALF=16;self.TILE_HEIGHT=32;self.TILE_HEIGHT_HALF=16;self.tileIndexes={};self.mode=0;self.modes={MOVE:0,ADD_TILE:1,DELETE_TILE:2,INSPECT:3};self.coordinates={row:0,col:0};self.offset={x:0,y:0};self.tile_count=0;self.tile_index=0;self.layer_index=0;self.mouse_down=false;self.mouse_animation_flag=false;self.debug=true;self.mouse_origin={x:0,y:0};self.mouse_origin_coordinates={row:0,col:0};if(!toolbar.hasChildNodes()){self.appendDOM()}var rendererOptions={antialiasing:false,transparent:false,resolution:1};self.renderer=PIXI.autoDetectRenderer(self.width,self.height,rendererOptions);self.canvas=target.appendChild(self.renderer.view);self.stage=new PIXI.Container;self.VIEWPORT_WIDTH_TILES=Math.ceil(self.width/self.TILE_WIDTH)+1;self.VIEWPORT_HEIGHT_TILES=Math.ceil(self.height/self.TILE_HEIGHT)+1;self.VIEWPORT_WIDTH_TILES_HALF=Math.ceil(self.VIEWPORT_WIDTH_TILES/2);self.VIEWPORT_HEIGHT_TILES_HALF=Math.ceil(self.VIEWPORT_HEIGHT_TILES/2);self.buffer=new PIXI.ParticleContainer;var index=0;var row=0;var col=0;var frameTexture;self.reloader=PIXI.loader;self.reloader.reset();_.each(map.terrain.source,function(asset){self.reloader.add("terrain_",realmResourceURL(asset))});self.reloader.add("cursor_",realmResourceURL("client/resource/cursors.png"));self.reloader.load(function(e,resources){_.each(resources,function(resource){if(self.tileIndexes[resource.name]===undefined){self.tileIndexes[resource.name]=0}for(row=0;row<resource.texture.height;row+=32){for(col=0;col<resource.texture.width;col+=32){frameTexture=new PIXI.Texture(resource.texture,{x:col,y:row,width:32,height:32});PIXI.Texture.addTextureToCache(frameTexture,resource.name+self.tileIndexes[resource.name]);self.tileIndexes[resource.name]=self.tileIndexes[resource.name]+1}}if(resource.name=="terrain_"){document.getElementById("modalTilesBody").appendChild(resource.texture.baseTexture.source);$("#modalTiles").children().first().width(resource.texture.width+30);self.tile_index=1018;$("#brushIndicator").css("background-image","url("+resource.url+")");$("#brushIndicator").css("background-position","-832px -992px")}});self.initialized=true;self.tile_count=index-1;self.texture=new PIXI.RenderTexture(self.renderer,self.renderer.width,self.renderer.height);self.layer_terrain=new PIXI.Sprite(self.texture);self.stage.addChild(self.layer_terrain);self.mouse_sprite=new PIXI.Sprite(PIXI.Texture.fromFrame("cursor_0"));self.mouse_sprite.visible=false;self.stage.addChild(self.mouse_sprite);self.mouse_sprite_highlight=new PIXI.Graphics;self.mouse_sprite_highlight.blendMode=PIXI.BLEND_MODES.DIFFERENCE;self.stage.addChild(self.mouse_sprite_highlight);self.setMode(self.modes.MOVE);self.invalidate=true;self.onInitialized()})}Map.prototype.setTile=function(screen_coordinates,tile_index){var self=this;var col=self.coordinates.col+Math.floor(screen_coordinates.x/self.TILE_WIDTH);var row=self.coordinates.row+Math.floor(screen_coordinates.y/self.TILE_HEIGHT);if(tile_index===null){if(self.terrain.index[row]){if(col in self.terrain.index[row]){delete self.terrain.index[row][col][self.layer_index]}}}else{if(self.terrain.index[row]===undefined){self.terrain.index[row]={}}if(self.terrain.index[row][col]===undefined){self.terrain.index[row][col]=[]}self.terrain.index[row][col][self.layer_index]=tile_index}self.invalidate=true;if(self.debug){console.log("setTile()'d at row: "+row+", col: "+col)}};Map.prototype.setMode=function(mode){var self=this;self.mode=mode;self.mouse_sprite_highlight.visible=false;switch(mode){case self.modes.INSPECT:self.mouse_sprite.visible=false;self.mouse_sprite_highlight.clear();self.mouse_sprite_highlight.lineStyle(1,16777215,1);self.mouse_sprite_highlight.moveTo(0,0);self.mouse_sprite_highlight.lineTo(32,0);self.mouse_sprite_highlight.lineTo(32,32);self.mouse_sprite_highlight.lineTo(0,32);self.mouse_sprite_highlight.lineTo(0,0);var mouse_coordinates={};self.mouse_sprite.texture=PIXI.Texture.fromFrame("cursor_4");self.canvas.onmousedown=function(event){self.mouse_down=true;self.mouse_origin={x:event.layerX,y:event.layerY};var col=self.coordinates.col+Math.floor(event.layerX/self.TILE_WIDTH);var row=self.coordinates.row+Math.floor(event.layerY/self.TILE_HEIGHT);mouse_coordinates={row:row,col:col};var x=event.layerX-event.layerX%self.TILE_WIDTH;var y=event.layerY-event.layerY%self.TILE_HEIGHT;self.mouse_sprite_highlight.x=x;self.mouse_sprite_highlight.y=y;self.mouse_sprite_highlight.visible=true;$("#inspectorOutput").text("ROW: "+row+", COL: "+col)};self.canvas.onmouseup=function(event){self.mouse_down=false};self.canvas.onmouseout=function(event){self.mouse_sprite.visible=false};self.canvas.onmousemove=function(event){if(!self.mouse_sprite.visible){self.mouse_sprite.visible=true}if(self.mouse_down){if(event.which===0){self.mouse_down=false}else{}}var x=event.layerX-10;var y=event.layerY-10;self.mouse_sprite.x=x;self.mouse_sprite.y=y};break;case self.modes.MOVE:self.mouse_sprite.texture=PIXI.Texture.fromFrame("cursor_0");self.canvas.onmousedown=function(event){self.mouse_down=true;self.mouse_origin={x:event.layerX,y:event.layerY};self.mouse_origin_coordinates={row:self.coordinates.row,col:self.coordinates.col};self.mouse_sprite.texture=PIXI.Texture.fromFrame("cursor_1")};self.canvas.onmouseup=function(event){self.mouse_down=false;self.mouse_sprite.texture=PIXI.Texture.fromFrame("cursor_0")};self.canvas.onmouseout=function(event){self.mouse_sprite.visible=false};self.canvas.onmousemove=function(event){if(!self.mouse_sprite.visible){self.mouse_sprite.visible=true}if(self.mouse_down){if(event.which===0){self.mouse_down=false}else{var offset_cols=Math.ceil((event.layerX-self.mouse_origin.x)/self.TILE_WIDTH_HALF);var offset_rows=Math.ceil((event.layerY-self.mouse_origin.y)/self.TILE_HEIGHT_HALF);self.coordinates.row=self.mouse_origin_coordinates.row-offset_rows;self.coordinates.col=self.mouse_origin_coordinates.col-offset_cols;self.invalidate=true}}var x=event.layerX-10;var y=event.layerY-10;self.mouse_sprite.x=x;self.mouse_sprite.y=y};break;case self.modes.DELETE_TILE:self.mouse_sprite.visible=false;self.mouse_sprite_highlight.clear();self.mouse_sprite_highlight.lineStyle(1,16777215,1);self.mouse_sprite_highlight.moveTo(0,0);self.mouse_sprite_highlight.lineTo(32,0);self.mouse_sprite_highlight.lineTo(32,32);self.mouse_sprite_highlight.lineTo(0,32);self.mouse_sprite_highlight.lineTo(0,0);self.mouse_sprite_highlight.lineTo(32,32);self.canvas.onmousedown=function(event){self.mouse_down=true;self.setTile({x:event.layerX,y:event.layerY},null)};self.canvas.onmouseup=function(event){self.mouse_down=false;self.save()};self.canvas.onmouseout=function(event){self.mouse_sprite.visible=false;self.mouse_sprite_highlight.visible=false};self.canvas.onmousemove=function(event){if(!self.mouse_sprite_highlight.visible){self.mouse_sprite_highlight.visible=true}if(self.mouse_down){if(event.which===0){self.mouse_down=false}else{self.setTile({x:event.layerX,y:event.layerY},null)}}var x=event.layerX-event.layerX%self.TILE_WIDTH;var y=event.layerY-event.layerY%self.TILE_HEIGHT;self.mouse_sprite_highlight.x=x;self.mouse_sprite_highlight.y=y};break;case self.modes.ADD_TILE:self.mouse_sprite.texture=PIXI.Texture.fromFrame("terrain_"+self.tile_index);self.mouse_sprite_highlight.clear();self.mouse_sprite_highlight.lineStyle(1,16777215,1);self.mouse_sprite_highlight.moveTo(0,0);self.mouse_sprite_highlight.lineTo(32,0);self.mouse_sprite_highlight.lineTo(32,32);self.mouse_sprite_highlight.lineTo(0,32);self.mouse_sprite_highlight.lineTo(0,0);self.canvas.onmousedown=function(event){self.mouse_down=true;self.setTile({x:event.layerX,y:event.layerY},self.tile_index)};self.canvas.onmouseup=function(event){self.mouse_down=false;self.save()};self.canvas.onmouseout=function(event){self.mouse_sprite.visible=false;self.mouse_sprite_highlight.visible=false};self.canvas.onmousemove=function(event){if(!self.mouse_sprite.visible){self.mouse_sprite.visible=true;self.mouse_sprite_highlight.visible=true}if(self.mouse_down){if(event.which===0){self.mouse_down=false}else{self.setTile({x:event.layerX,y:event.layerY},self.tile_index)}}var x=event.layerX-event.layerX%self.TILE_WIDTH;var y=event.layerY-event.layerY%self.TILE_HEIGHT;self.mouse_sprite.x=x;self.mouse_sprite.y=y;self.mouse_sprite_highlight.x=x;self.mouse_sprite_highlight.y=y};break}};Map.prototype.draw=function(full){var self=this;self.buffer.children=[];self.texture.clear();var index;var sprite;var layers;var i;for(var row=self.coordinates.row;row<self.coordinates.row+self.VIEWPORT_HEIGHT_TILES;row++){for(var col=self.coordinates.col;col<self.coordinates.col+self.VIEWPORT_WIDTH_TILES;col++){if(self.terrain.index[row]===undefined)continue;if(self.terrain.index[row][col]===undefined)continue;layers=self.terrain.index[row][col];if(layers.constructor!==Array)continue;for(i=0;i<layers.length;i++){index=layers[i];if(index!==null&&index!==undefined){sprite=new PIXI.Sprite(PIXI.Texture.fromFrame("terrain_"+index));sprite.position.x=(col-self.coordinates.col)*self.TILE_WIDTH;sprite.position.y=(row-self.coordinates.row)*self.TILE_HEIGHT;self.buffer.addChild(sprite)}}}}if(full){self.texture.render(self.buffer)}};Map.prototype.render=function(){var self=this;if(self.invalidate){self.draw(true);self.invalidate=false}if(self.mouse_sprite_highlight.alpha>=1){self.mouse_animation_flag=true}else if(self.mouse_sprite_highlight.alpha<=.1){self.mouse_animation_flag=false}if(self.mouse_animation_flag){self.mouse_sprite_highlight.alpha-=.05}else{self.mouse_sprite_highlight.alpha+=.05}if(self.texture){self.renderer.render(self.stage)}};Map.prototype.appendDOM=function(){var self=this;var html=['<button type="button" class="btn btn-default navbar-btn btn-map-tool active" id="moveButton" data-toggle="tooltip" data-container="body" data-placement="bottom" title="Navigate the map">',"<div style=\"background-image: url('/build/img/cursors.png'); width: 20px; height: 22px; background-position:-39px -8px\"></div>","</button>",'<button type="button" class="btn btn-default navbar-btn btn-map-tool" id="inspectButton" data-toggle="tooltip" data-container="body" data-placement="bottom" title="Reveal details of selected tile">',"<div style=\"background-image: url('/build/img/cursors.png'); width: 20px; height: 22px; background-position:-179px -6px\"></div>","</button>",'<button type="button" class="btn btn-default navbar-btn btn-map-tool" id="eraseButton" data-toggle="tooltip" data-container="body" data-placement="bottom" title="Erase tiles from the map">',"<div style=\"background-image: url('/build/img/cursors.png'); width: 20px; height: 22px; background-position:-216px -6px\"></div>","</button>",'<button type="button" class="btn btn-default navbar-btn btn-map-tool" id="addButton" data-toggle="tooltip" data-container="body" data-placement="bottom" title="Add tiles">',"<div style=\"background-image: url('/build/img/cursors.png'); width: 20px; height: 22px; background-position:-6px -6px\"></div>","</button>",'<div class="spacer"></div>','<div id="addTools" style="display: none;">','<button type="button" id="tileModalButton" class="btn btn-default navbar-btn btn-map-tool" data-consumers="addButton" data-toggle="modal" data-target="#modalTiles">','<div id="brushIndicator" style="width: 32px; height: 32px; vertical-align: middle; display: inline-block;"></div>&nbsp','<span class="caret"></span>',"</button>",'<div class="dropdown btn-map-tool" data-consumers="addButton eraseButton" style="display: inline;">','<button class="btn btn-default navbar-btn dropdown-toggle" type="button" id="layersMenu" data-toggle="dropdown" aria-expanded="true">',"Editing Layer: 1 ",'<span class="caret"></span>',"</button>",'<ul class="dropdown-menu" role="menu" aria-labelledby="layersMenu" id="layersMenuList">','<li role="presentation"><a role="menuitem" tabindex="-1" href="#">Layer 1, Walkable</a></li>','<li role="presentation"><a role="menuitem" tabindex="-1" href="#">Layer 2, Walkable</a></li>','<li role="presentation"><a role="menuitem" tabindex="-1" href="#">Layer 3, Non-Walkable</a></li>','<li role="presentation"><a role="menuitem" tabindex="-1" href="#">Layer 4, Above Ground</a></li>',"</ul>","</div>","</div>"].join("\n");document.getElementById("mapToolbar").innerHTML=html;html=['<div id="inspectorOutput" style="min-height: 200px;">',"</div>",'<div class="modal fade tiles-modal-lg" id="modalTiles" tabindex="-1" role="dialog" aria-hidden="true">','<div class="modal-dialog modal-lg">','<div class="modal-content">','<div class="modal-header clearfix">','<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>','<h4 class="modal-title pull-left" style="width: 230px;">Select a tile from category: </h4>','<select id="categorySelection" class="form-control pull-left" style="display: inline-block; width: 125px; margin-top: -4px;">','<option data-id="terrain">Terrain</option>','<option data-id="objects">Objects</option>',"</select>","</div>",'<div id="modalTilesBody" class="modal-body" style="overflow-x: scroll;">','<div id="tilesHoverIdentifier" style="width: 32px; height: 32px; position: relative; z-index: 9999; display: none; pointer-events: none;">','<div style="width: 32px; height: 32px; position: absolute; pointer-events: none; left: 0; top: 0;" class="hover-identifier-border-top"></div>','<div style="width: 32px; height: 32px; position: absolute; pointer-events: none; left: 0; top: 0;" class="hover-identifier-border-left"></div>','<div style="width: 32px; height: 32px; position: absolute; pointer-events: none; left: 0; top: 0;" class="hover-identifier-border-bottom"></div>','<div style="width: 32px; height: 32px; position: absolute; pointer-events: none; left: 0; top: 0;" class="hover-identifier-border-right"></div>',"</div>","</div>","</div>","</div>","</div>","</div>"].join("\n");document.getElementById("mapDetails").innerHTML=html;$("#modalTilesBody").on("mousedown","img",function(e){var offset=$(this).offset();var width=$(this).width();var point={x:e.pageX-offset.left,y:e.pageY-offset.top};var row_tile_width=Math.round(width/32);var rows_to_add=Math.floor(point.y/32);self.tile_index=rows_to_add*row_tile_width+Math.floor(point.x/32);if(self.mode===self.modes.ADD_TILE){self.mouse_sprite.texture=PIXI.Texture.fromFrame("terrain_"+self.tile_index)}var background_x=(point.x-point.x%32)*-1;var background_y=(point.y-point.y%32)*-1;$("#brushIndicator").css("background-image","url("+e.currentTarget.src+")");$("#brushIndicator").css("background-position",background_x+"px "+background_y+"px");$("#modalTiles").modal("hide")});$("#modalTilesBody").on("mousemove","img",function(e){$("#tilesHoverIdentifier").show();var offset=$(this).offset();var point={x:e.pageX-offset.left,y:e.pageY-offset.top};var y_offset=point.y%32;var x_offset=point.x%32;$("#tilesHoverIdentifier").css("top",point.y-y_offset+32+"px");$("#tilesHoverIdentifier").css("left",point.x-x_offset+"px")});$("#modalTiles").on("hidden.bs.modal",function(e){$("#tilesHoverIdentifier").hide()});$("#layersMenuList").on("click","li",function(e){var index=$(e.currentTarget).index();self.layer_index=index;$("#layersMenu").html("Editing Layer: "+(index+1)+'&nbsp;<span class="caret"></span>')});$("#moveButton").on("click",function(){self.setMode(self.modes.MOVE);$(this).addClass("active").siblings().removeClass("active");self.resetToolbar("moveButton")});$("#inspectButton").on("click",function(){self.setMode(self.modes.INSPECT);$(this).addClass("active").siblings().removeClass("active");self.resetToolbar("inspectButton")});$("#eraseButton").on("click",function(){self.setMode(self.modes.DELETE_TILE);$(this).addClass("active").siblings().removeClass("active");self.resetToolbar("eraseButton")});$("#addButton").on("click",function(){self.setMode(self.modes.ADD_TILE);$(this).addClass("active").siblings().removeClass("active");self.resetToolbar("addButton")})};Map.prototype.resetToolbar=function(selectedTool){$("#addTools").fadeOut(function(){$("#addTools .btn-map-tool").each(function(){if($(this).attr("data-consumers").indexOf(selectedTool)>-1){$(this).show()}else{$(this).hide()}});$("#addTools").fadeIn().css("display","inline-block")})};